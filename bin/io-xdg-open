#!/bin/sh -e
# pick a file to open with xdg-open with iomenu with caching
#
# The cache is updated when a directory is selected.

LC_COLLATE=C

touch "$HOME/.cache/find"

if	test -f "$HOME/.cache/find" && test $# = 0
then	exec "$0" "$HOME"
elif	test $# = 0
then	exec xdg-open "$(iomenu <$HOME/.cache/find)"
fi

mkdir -p "$HOME/.cache"
{
	find "$1" '(' -name .git -o -name CVS ')' -prune -o \
		-type d -exec printf '%s/\n' '{}' + -o \
		-type f -exec printf '%s\n' '{}' + | tee "$HOME/.cache/$$" 
	grep -vF "$1" $HOME/.cache/find
} | sort -o "$HOME/.cache/find"

s=$(iomenu <$HOME/.cache/$$)

rm "$HOME/.cache/$$"

case $s in
('')	exit 1 ;;
(*/)	exec "$0" "$(cd "$s" && pwd)" ;;
(*)	exec xdg-open "$s" ;;
esac
